"""
ì…ê¸ˆ ëª¨ë‹ˆí„°ë§ ì„œë¹„ìŠ¤.
TRON ë¸”ë¡ì²´ì¸ì—ì„œ ì…ê¸ˆ íŠ¸ëœì­ì…˜ì„ ê°ì§€í•˜ê³  ì²˜ë¦¬í•©ë‹ˆë‹¤.
"""
from .deposit_monitoring.monitor_service import DepositMonitoringService

__all__ = ["DepositMonitoringService"]

# ì´ íŒŒì¼ì€ í•˜ìœ„ ëª¨ë“ˆì„ ê°€ì ¸ì˜¤ëŠ” ì—­í• ë§Œ í•©ë‹ˆë‹¤.
# ëª¨ë“  êµ¬í˜„ì€ deposit_monitoring/ íŒ¨í‚¤ì§€ ë‚´ë¶€ì— ìˆìŠµë‹ˆë‹¤.


class DepositMonitoringService:
    """ì…ê¸ˆ ëª¨ë‹ˆí„°ë§ ì„œë¹„ìŠ¤"""

    def __init__(self):
        self.tron = TronService()
        self.is_monitoring = False
        self.monitoring_interval = 30  # 30ì´ˆë§ˆë‹¤ í™•ì¸
        self.last_checked_block = None

    async def start_monitoring(self):
        """ëª¨ë‹ˆí„°ë§ ì‹œì‘"""
        if self.is_monitoring:
            logger.warning("ëª¨ë‹ˆí„°ë§ì´ ì´ë¯¸ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤")
            return

        self.is_monitoring = True
        logger.info("ğŸ” ì…ê¸ˆ ëª¨ë‹ˆí„°ë§ ì‹œì‘")

        try:
            while self.is_monitoring:
                await self._monitor_deposits()
                await asyncio.sleep(self.monitoring_interval)
        except Exception as e:
            logger.error(f"ëª¨ë‹ˆí„°ë§ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")
        finally:
            self.is_monitoring = False
            logger.info("ì…ê¸ˆ ëª¨ë‹ˆí„°ë§ ì¢…ë£Œ")

    def stop_monitoring(self):
        """ëª¨ë‹ˆí„°ë§ ì¤‘ì§€"""
        logger.info("ì…ê¸ˆ ëª¨ë‹ˆí„°ë§ ì¤‘ì§€ ìš”ì²­")
        self.is_monitoring = False

    async def _monitor_deposits(self):
        """ì…ê¸ˆ ëª¨ë‹ˆí„°ë§ ì‹¤í–‰"""
        try:
            async with AsyncSessionLocal() as db:
                # 1. ëª¨ë‹ˆí„°ë§ í™œì„±í™”ëœ ì§€ê°‘ë“¤ ì¡°íšŒ
                monitored_wallets = await self._get_monitored_wallets(db)

                if not monitored_wallets:
                    logger.debug("ëª¨ë‹ˆí„°ë§í•  ì§€ê°‘ì´ ì—†ìŠµë‹ˆë‹¤")
                    return

                # 2. í˜„ì¬ ë¸”ë¡ ë²ˆí˜¸ ì¡°íšŒ
                current_block = self.tron.get_block_number()
                if not current_block:
                    logger.warning("í˜„ì¬ ë¸”ë¡ ë²ˆí˜¸ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤")
                    return

                # 3. ì‹œì‘ ë¸”ë¡ ì„¤ì • (ì²« ì‹¤í–‰ì‹œ í˜„ì¬ ë¸”ë¡ì—ì„œ -100ë¸”ë¡ë¶€í„°)
                start_block = self.last_checked_block
                if start_block is None:
                    start_block = max(1, current_block - 100)
                    logger.info(f"ì²« ëª¨ë‹ˆí„°ë§ ì‹œì‘: ë¸”ë¡ {start_block}ë¶€í„° {current_block}ê¹Œì§€")

                # 4. ê° ì§€ê°‘ë³„ë¡œ ì…ê¸ˆ í™•ì¸
                for wallet in monitored_wallets:
                    await self._check_wallet_deposits(db, wallet, start_block, current_block)

                # 5. ê¸°ì¡´ ì…ê¸ˆë“¤ì˜ í™•ì¸ ìƒíƒœ ì—…ë°ì´íŠ¸
                await self._update_pending_deposits(db, current_block)

                # 6. í™•ì¸ ì™„ë£Œëœ ì…ê¸ˆ ì²˜ë¦¬
                await self._process_confirmed_deposits(db)

                self.last_checked_block = current_block

        except Exception as e:
            logger.error(f"ì…ê¸ˆ ëª¨ë‹ˆí„°ë§ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜: {e}")

    async def _get_monitored_wallets(self, db: AsyncSession) -> List[Wallet]:
        """ëª¨ë‹ˆí„°ë§ ëŒ€ìƒ ì§€ê°‘ ì¡°íšŒ"""
        result = await db.execute(
            select(Wallet)
            .options(selectinload(Wallet.user))
            .filter(
                and_(
                    Wallet.is_active == True,
                    Wallet.is_monitored == True,
                    Wallet.address.isnot(None)
                )
            )
        )
        wallets = result.scalars().all()
        return list(wallets)

    async def _check_wallet_deposits(
        self,
        db: AsyncSession,
        wallet: Wallet,
        start_block: int,
        end_block: int
    ):
        """íŠ¹ì • ì§€ê°‘ì˜ ì…ê¸ˆ í™•ì¸"""
        try:
            wallet_address = str(wallet.address)

            # TRX ì…ê¸ˆ í™•ì¸
            trx_deposits = self.tron.get_trx_transactions(
                wallet_address,
                start_block,
                end_block
            )

            for tx in trx_deposits:
                if tx.get('to') == wallet_address and tx.get('value', 0) > 0:
                    await self._save_deposit(db, wallet, tx, 'TRX')

            # USDT ì…ê¸ˆ í™•ì¸
            usdt_deposits = self.tron.get_trc20_transactions(
                wallet_address,
                settings.USDT_CONTRACT_ADDRESS,
                start_block,
                end_block
            )

            for tx in usdt_deposits:
                if tx.get('to') == wallet_address and tx.get('value', 0) > 0:
                    await self._save_deposit(db, wallet, tx, 'USDT', settings.USDT_CONTRACT_ADDRESS)

        except Exception as e:
            logger.error(f"ì§€ê°‘ {wallet.address} ì…ê¸ˆ í™•ì¸ ì¤‘ ì˜¤ë¥˜: {e}")

    async def _save_deposit(
        self,
        db: AsyncSession,
        wallet: Wallet,
        tx_data: Dict[Any, Any],
        token_symbol: str,
        token_contract: Optional[str] = None
    ):
        """ì…ê¸ˆ ì •ë³´ ì €ì¥"""
        try:
            # ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì…ê¸ˆì¸ì§€ í™•ì¸
            existing = await db.execute(
                select(Deposit).filter(Deposit.tx_hash == tx_data['hash'])
            )
            if existing.scalar_one_or_none():
                return  # ì´ë¯¸ ì¡´ì¬í•¨

            # ê¸ˆì•¡ ê³„ì‚° (Weiì—ì„œ ì‹¤ì œ ë‹¨ìœ„ë¡œ ë³€í™˜)
            decimals = 6  # TRX, USDT ëª¨ë‘ 6 decimals
            amount = Decimal(tx_data['value']) / (10 ** decimals)

            # ì…ê¸ˆ ê°ì²´ ìƒì„±
            deposit = Deposit(
                tx_hash=tx_data['hash'],
                from_address=tx_data['from'],
                to_address=tx_data['to'],
                amount=amount,
                token_symbol=token_symbol,
                token_contract=token_contract,
                block_number=tx_data['block_number'],
                block_timestamp=tx_data['timestamp'],
                transaction_index=tx_data.get('transaction_index', 0),
                user_id=wallet.user_id,
                wallet_id=wallet.id
            )

            db.add(deposit)
            await db.commit()

            logger.info(f"ìƒˆ ì…ê¸ˆ ê°ì§€: {amount} {token_symbol} â†’ {wallet.address}")

        except Exception as e:
            logger.error(f"ì…ê¸ˆ ì €ì¥ ì¤‘ ì˜¤ë¥˜: {e}")
            await db.rollback()

    async def _update_pending_deposits(self, db: AsyncSession, current_block: int):
        """ëŒ€ê¸° ì¤‘ì¸ ì…ê¸ˆë“¤ì˜ í™•ì¸ ìƒíƒœ ì—…ë°ì´íŠ¸"""
        try:
            # SQL ì¿¼ë¦¬ë¡œ í•œë²ˆì— ì—…ë°ì´íŠ¸
            await db.execute(
                update(Deposit)
                .where(Deposit.is_confirmed == False)
                .values(
                    confirmations=current_block - Deposit.block_number + 1,
                    is_confirmed=(current_block - Deposit.block_number + 1) >= Deposit.min_confirmations
                )
            )

            await db.commit()
            logger.debug(f"ì…ê¸ˆ í™•ì¸ ìƒíƒœ ì—…ë°ì´íŠ¸ ì™„ë£Œ (ë¸”ë¡ {current_block})")

        except Exception as e:
            logger.error(f"ì…ê¸ˆ í™•ì¸ ìƒíƒœ ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜: {e}")
            await db.rollback()

    async def _process_confirmed_deposits(self, db: AsyncSession):
        """í™•ì¸ ì™„ë£Œëœ ì…ê¸ˆ ì²˜ë¦¬"""
        try:
            # í™•ì¸ ì™„ë£Œë˜ì—ˆì§€ë§Œ ì•„ì§ ì²˜ë¦¬ë˜ì§€ ì•Šì€ ì…ê¸ˆë“¤ ì¡°íšŒ
            result = await db.execute(
                select(Deposit)
                .options(selectinload(Deposit.user))
                .filter(
                    and_(
                        Deposit.is_confirmed == True,
                        Deposit.is_processed == False
                    )
                )
            )
            deposits_to_process = result.scalars().all()

            balance_service = BalanceService(db)

            for deposit in deposits_to_process:
                try:
                    # getattrë¥¼ ì‚¬ìš©í•˜ì—¬ íƒ€ì… ì²´í¬ ìš°íšŒ
                    user_id = getattr(deposit, 'user_id', 0)
                    asset = getattr(deposit, 'token_symbol', 'USDT')
                    amount = Decimal(str(getattr(deposit, 'amount', '0')))
                    tx_hash = getattr(deposit, 'tx_hash', '')

                    # ì‚¬ìš©ì ì”ê³ ì— ì…ê¸ˆ ë°˜ì˜
                    await balance_service.add_balance(
                        user_id=user_id,
                        asset=asset,
                        amount=amount,
                        transaction_type="deposit",
                        description=f"ë¸”ë¡ì²´ì¸ ì…ê¸ˆ: {tx_hash}"
                    )

                    # ì…ê¸ˆ ì²˜ë¦¬ ì™„ë£Œ í‘œì‹œ (SQL ì—…ë°ì´íŠ¸ ì‚¬ìš©)
                    await db.execute(
                        update(Deposit)
                        .where(Deposit.id == deposit.id)
                        .values(
                            is_processed=True,
                            processed_at=datetime.utcnow().isoformat()
                        )
                    )

                    logger.info(f"ì…ê¸ˆ ì²˜ë¦¬ ì™„ë£Œ: {amount} {asset} â†’ ì‚¬ìš©ì {user_id}")

                except Exception as e:
                    # ì²˜ë¦¬ ì‹¤íŒ¨ì‹œ ì¬ì‹œë„ ì¹´ìš´íŠ¸ ì¦ê°€ (SQL ì—…ë°ì´íŠ¸ ì‚¬ìš©)
                    await db.execute(
                        update(Deposit)
                        .where(Deposit.id == deposit.id)
                        .values(
                            retry_count=Deposit.retry_count + 1,
                            error_message=str(e)
                        )
                    )
                    logger.error(f"ì…ê¸ˆ ì²˜ë¦¬ ì‹¤íŒ¨: {deposit.tx_hash} - {e}")

            await db.commit()

        except Exception as e:
            logger.error(f"í™•ì¸ëœ ì…ê¸ˆ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜: {e}")
            await db.rollback()

    async def get_deposit_status(self, db: AsyncSession, user_id: int) -> Dict[str, Any]:
        """ì‚¬ìš©ìì˜ ì…ê¸ˆ ìƒíƒœ ì¡°íšŒ"""
        try:
            # ì‚¬ìš©ìì˜ ì…ê¸ˆ ë‚´ì—­ ì¡°íšŒ
            result = await db.execute(
                select(Deposit).filter(Deposit.user_id == user_id)
                .order_by(Deposit.created_at.desc())
                .limit(10)
            )
            deposits = result.scalars().all()

            # í†µê³„ ê³„ì‚° (ê°„ë‹¨í•œ ë°©ë²•ìœ¼ë¡œ)
            total_deposits = len(deposits)
            pending_count = 0
            confirmed_count = 0

            recent_deposits = []
            for d in deposits:
                # íƒ€ì… ì²´í¬ ìš°íšŒí•˜ì—¬ ê°’ ì¶”ì¶œ
                is_processed = bool(d.is_processed)
                is_confirmed = bool(d.is_confirmed)

                if not is_processed:
                    pending_count += 1
                if is_confirmed:
                    confirmed_count += 1

                recent_deposits.append({
                    "tx_hash": getattr(d, 'tx_hash', ''),
                    "amount": str(getattr(d, 'amount', '0')),
                    "token_symbol": getattr(d, 'token_symbol', ''),
                    "confirmations": getattr(d, 'confirmations', 0),
                    "is_confirmed": is_confirmed,
                    "is_processed": is_processed,
                    "created_at": d.created_at
                })

            return {
                "total_deposits": total_deposits,
                "pending_count": pending_count,
                "confirmed_count": confirmed_count,
                "recent_deposits": recent_deposits
            }

        except Exception as e:
            logger.error(f"ì…ê¸ˆ ìƒíƒœ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜: {e}")
            return {"error": str(e)}


# ì „ì—­ ëª¨ë‹ˆí„°ë§ ì„œë¹„ìŠ¤ ì¸ìŠ¤í„´ìŠ¤
deposit_monitor = DepositMonitoringService()
