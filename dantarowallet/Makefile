.PHONY: help install dev test lint format clean db-init db-migrate db-upgrade db-downgrade db-history metrics refactor-check refactor-plan pre-commit quality-gate

help:
	@echo "Available commands:"
	@echo "  install          Install dependencies"
	@echo "  dev              Run development server"
	@echo "  test             Run tests"
	@echo "  lint             Run linters"
	@echo "  format           Format code"
	@echo "  clean            Clean up"
	@echo "  db-init          Initialize database"
	@echo "  db-migrate       Create migration (usage: make db-migrate m='message')"
	@echo "  db-upgrade       Upgrade database to head"
	@echo "  db-downgrade     Downgrade database by one version"
	@echo "  db-history       Show database migration history"
	@echo ""
	@echo "Refactoring & Quality:"
	@echo "  metrics          Generate code metrics report"
	@echo "  refactor-check   Check which files need refactoring"
	@echo "  refactor-plan    Generate refactoring action plan"
	@echo "  pre-commit       Run pre-commit quality checks"
	@echo "  quality-gate     Run comprehensive quality gate"

install:
	poetry install

dev:
	docker-compose up -d postgres redis
	poetry run uvicorn app.main:app --reload

test:
	poetry run pytest -v --cov=app

lint:
	poetry run flake8 app tests
	poetry run mypy app

format:
	poetry run black app tests

clean:
	find . -type d -name __pycache__ -exec rm -rf {} +
	find . -type f -name "*.pyc" -delete
	docker-compose down -v

db-init:
	poetry run python scripts/init_db.py

db-migrate:
	poetry run alembic revision --autogenerate -m "$(m)"

db-upgrade:
	poetry run alembic upgrade head

db-downgrade:
	poetry run alembic downgrade -1

db-history:
	poetry run alembic history

# Refactoring & Quality Commands
metrics:
	@echo "ğŸ“Š Generating code metrics report..."
	poetry run python scripts/refactoring_monitor.py

refactor-check:
	@echo "ğŸ” Checking files that need refactoring..."
	poetry run python scripts/refactoring_monitor.py
	@echo "ğŸ“‹ Check docs/CODE_METRICS_REPORT.md for detailed analysis"

refactor-plan:
	@echo "ğŸ“‹ Generating refactoring action plan..."
	poetry run python scripts/refactoring_monitor.py
	@echo "ğŸ“ Action plan generated in docs/refactoring_action_plan.json"

pre-commit:
	@echo "ğŸš€ Running pre-commit quality checks..."
	poetry run python scripts/pre_commit_check.py

quality-gate:
	@echo "ğŸ—ï¸ Running comprehensive quality gate..."
	@make lint
	@make test
	@make metrics
	@make pre-commit
	@echo "âœ… Quality gate completed"

# Install quality tools
install-quality-tools:
	poetry add --group dev radon bandit isort black mypy flake8
	@echo "âœ… Quality tools installed"

# ê°œë°œ ì‹œ ìë™ í’ˆì§ˆ ê²€ì‚¬ ëª…ë ¹ì–´ë“¤
auto-fix:
	@echo "ğŸ”§ ìë™ ì½”ë“œ ìˆ˜ì • ì‹œì‘..."
	poetry run black app tests scripts
	poetry run isort app tests scripts
	@echo "âœ… ìë™ ìˆ˜ì • ì™„ë£Œ!"

auto-check:
	@echo "ğŸ” ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬ ì‹œì‘..."
	poetry run black --check app tests scripts
	poetry run isort --check-only app tests scripts
	poetry run flake8 app tests scripts
	poetry run mypy app
	poetry run bandit -r app/
	@echo "âœ… í’ˆì§ˆ ê²€ì‚¬ ì™„ë£Œ!"

dev-check: auto-fix auto-check test
	@echo "ğŸš€ ê°œë°œ ì „ ëª¨ë“  ê²€ì‚¬ ì™„ë£Œ! ê°œë°œ ì‹œì‘í•˜ì„¸ìš”."

build-test:
	@echo "ğŸ—ï¸ ë¹Œë“œ í…ŒìŠ¤íŠ¸ ì‹œì‘..."
	poetry check
	poetry run python -m app.main --help > /dev/null 2>&1 || echo "âŒ ì•± ë¡œë“œ ì‹¤íŒ¨"
	poetry run pytest tests/test_app.py::test_app_startup -v
	@echo "âœ… ë¹Œë“œ í…ŒìŠ¤íŠ¸ ì™„ë£Œ!"

pre-dev: install auto-fix auto-check build-test
	@echo "ğŸ¯ ê°œë°œ í™˜ê²½ ì¤€ë¹„ ì™„ë£Œ!"
	@echo "   âœ… ì˜ì¡´ì„± ì„¤ì¹˜"
	@echo "   âœ… ì½”ë“œ ìë™ ìˆ˜ì •"
	@echo "   âœ… í’ˆì§ˆ ê²€ì‚¬"
	@echo "   âœ… ë¹Œë“œ í…ŒìŠ¤íŠ¸"
	@echo "ğŸš€ ì´ì œ 'make dev'ë¡œ ì„œë²„ë¥¼ ì‹œì‘í•˜ì„¸ìš”!"

watch-dev:
	@echo "ğŸ‘€ ê°œë°œ ëª¨ë“œ: íŒŒì¼ ë³€ê²½ ì‹œ ìë™ ê²€ì‚¬"
	poetry run watchdog --recursive --ignore-directories=__pycache__ --ignore-directories=.git --patterns="*.py" --command="make auto-fix && make auto-check" app/
