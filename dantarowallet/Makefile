.PHONY: help install dev test lint format clean db-init db-migrate db-upgrade db-downgrade db-history metrics refactor-check refactor-plan pre-commit quality-gate

help:
	@echo "ğŸ¯ DantaroWallet ê°œë°œ ëª…ë ¹ì–´ ê°€ì´ë“œ"
	@echo "======================================"
	@echo ""
	@echo "ğŸš€ ê¸°ë³¸ ê°œë°œ ëª…ë ¹ì–´:"
	@echo "  install          Install dependencies"
	@echo "  dev              Run development server"
	@echo "  test             Run tests"
	@echo "  lint             Run linters"
	@echo "  format           Format code"
	@echo "  clean            Clean up"
	@echo ""
	@echo "ğŸ—„ï¸ ë°ì´í„°ë² ì´ìŠ¤:"
	@echo "  db-init          Initialize database"
	@echo "  db-migrate       Create migration (usage: make db-migrate m='message')"
	@echo "  db-upgrade       Upgrade database to head"
	@echo "  db-downgrade     Downgrade database by one version"
	@echo "  db-history       Show database migration history"
	@echo ""
	@echo "ğŸ¯ í”„ë¡ íŠ¸ì—”ë“œ ê°œë°œ ì§€ì›:"
	@echo "  frontend-help    í”„ë¡ íŠ¸ì—”ë“œ ê°œë°œì ê°€ì´ë“œ í‘œì‹œ"
	@echo "  dev-server       ë°±ì—”ë“œ ê°œë°œ ì„œë²„ ì‹¤í–‰"
	@echo "  frontend-test    API ì—°ê²° í…ŒìŠ¤íŠ¸"
	@echo "  frontend-ready   í”„ë¡ íŠ¸ì—”ë“œ ê°œë°œ í™˜ê²½ ì™„ì „ ì¤€ë¹„"
	@echo "  update-api-docs  API ë¬¸ì„œ ë° TypeScript íƒ€ì… ì—…ë°ì´íŠ¸"
	@echo "  generate-api-types TypeScript API íƒ€ì… ìƒì„±"
	@echo "  monitor-api      ì‹¤ì‹œê°„ API ëª¨ë‹ˆí„°ë§"
	@echo ""
	@echo "ğŸ“š API ë¬¸ì„œ:"
	@echo "  api-docs         Update role-based API documentation"
	@echo "  api-test         Test API endpoints"
	@echo ""
	@echo "ğŸ”§ ì½”ë“œ í’ˆì§ˆ & ë¦¬íŒ©í† ë§:"
	@echo "  metrics          Generate code metrics report"
	@echo "  refactor-check   Check which files need refactoring"
	@echo "  refactor-plan    Generate refactoring action plan"
	@echo "  pre-commit       Run pre-commit quality checks"
	@echo "  quality-gate     Run comprehensive quality gate"
	@echo "  auto-fix         ìë™ ì½”ë“œ ìˆ˜ì • (black, isort)"
	@echo "  auto-check       ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬"
	@echo ""
	@echo "ğŸš€ í†µí•© ì›Œí¬í”Œë¡œìš°:"
	@echo "  full-dev-setup   ì™„ì „í•œ ê°œë°œ í™˜ê²½ ì„¤ì •"
	@echo "  pre-dev          ê°œë°œ ì „ ì¤€ë¹„ ì‘ì—…"
	@echo "  dev-check        ê°œë°œ ì „ ëª¨ë“  ê²€ì‚¬"
	@echo ""
	@echo "ğŸ§¹ íŒŒì¼ ì •ë¦¬:"
	@echo "  clean-empty      ë¹ˆ íŒŒì¼ë“¤ ì •ë¦¬ (ì•ˆì „ ëª¨ë“œ)"
	@echo "  clean-empty-force ë¹ˆ íŒŒì¼ë“¤ ê°•ì œ ì •ë¦¬"
	@echo "  prevent-empty    ë¹ˆ íŒŒì¼ ìƒì„± ë°©ì§€ ëª¨ë‹ˆí„°ë§"
	@echo "  prevent-empty-check ë¹ˆ íŒŒì¼ ê²€ì‚¬ë§Œ ì‹¤í–‰"
	@echo ""

install:
	poetry install

dev:
	docker-compose up -d postgres redis
	poetry run uvicorn app.main:app --reload

test:
	poetry run pytest -v --cov=app

lint:
	poetry run flake8 app tests
	poetry run mypy app

format:
	poetry run black app tests

clean:
	find . -type d -name __pycache__ -exec rm -rf {} +
	find . -type f -name "*.pyc" -delete
	docker-compose down -v

db-init:
	poetry run python scripts/init_db.py

db-migrate:
	poetry run alembic revision --autogenerate -m "$(m)"

db-upgrade:
	poetry run alembic upgrade head

db-downgrade:
	poetry run alembic downgrade -1

db-history:
	poetry run alembic history

# Refactoring & Quality Commands
metrics:
	@echo "ğŸ“Š Generating code metrics report..."
	poetry run python scripts/refactoring_monitor.py

refactor-check:
	@echo "ğŸ” Checking files that need refactoring..."
	poetry run python scripts/refactoring_monitor.py
	@echo "ğŸ“‹ Check docs/CODE_METRICS_REPORT.md for detailed analysis"

refactor-plan:
	@echo "ğŸ“‹ Generating refactoring action plan..."
	poetry run python scripts/refactoring_monitor.py
	@echo "ğŸ“ Action plan generated in docs/refactoring_action_plan.json"

pre-commit:
	@echo "ğŸš€ Running pre-commit quality checks..."
	poetry run python scripts/pre_commit_check.py

quality-gate:
	@echo "ğŸ—ï¸ Running comprehensive quality gate..."
	@make lint
	@make test
	@make metrics
	@make pre-commit
	@echo "âœ… Quality gate completed"

# Install quality tools
install-quality-tools:
	poetry add --group dev radon bandit isort black mypy flake8
	@echo "âœ… Quality tools installed"

# ê°œë°œ ì‹œ ìë™ í’ˆì§ˆ ê²€ì‚¬ ëª…ë ¹ì–´ë“¤
auto-fix:
	@echo "ğŸ”§ ìë™ ì½”ë“œ ìˆ˜ì • ì‹œì‘..."
	poetry run black app tests scripts
	poetry run isort app tests scripts
	@echo "âœ… ìë™ ìˆ˜ì • ì™„ë£Œ!"

auto-check:
	@echo "ğŸ” ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬ ì‹œì‘..."
	poetry run black --check app tests scripts
	poetry run isort --check-only app tests scripts
	poetry run flake8 app tests scripts
	poetry run mypy app
	poetry run bandit -r app/
	@echo "âœ… í’ˆì§ˆ ê²€ì‚¬ ì™„ë£Œ!"

dev-check: auto-fix auto-check test
	@echo "ğŸš€ ê°œë°œ ì „ ëª¨ë“  ê²€ì‚¬ ì™„ë£Œ! ê°œë°œ ì‹œì‘í•˜ì„¸ìš”."

build-test:
	@echo "ğŸ—ï¸ ë¹Œë“œ í…ŒìŠ¤íŠ¸ ì‹œì‘..."
	poetry check
	poetry run python -m app.main --help > /dev/null 2>&1 || echo "âŒ ì•± ë¡œë“œ ì‹¤íŒ¨"
	poetry run pytest tests/test_app.py::test_app_startup -v
	@echo "âœ… ë¹Œë“œ í…ŒìŠ¤íŠ¸ ì™„ë£Œ!"

pre-dev: install auto-fix auto-check build-test
	@echo "ğŸ¯ ê°œë°œ í™˜ê²½ ì¤€ë¹„ ì™„ë£Œ!"
	@echo "   âœ… ì˜ì¡´ì„± ì„¤ì¹˜"
	@echo "   âœ… ì½”ë“œ ìë™ ìˆ˜ì •"
	@echo "   âœ… í’ˆì§ˆ ê²€ì‚¬"
	@echo "   âœ… ë¹Œë“œ í…ŒìŠ¤íŠ¸"
	@echo "ğŸš€ ì´ì œ 'make dev'ë¡œ ì„œë²„ë¥¼ ì‹œì‘í•˜ì„¸ìš”!"

watch-dev:
	@echo "ğŸ‘€ ê°œë°œ ëª¨ë“œ: íŒŒì¼ ë³€ê²½ ì‹œ ìë™ ê²€ì‚¬"
	poetry run watchdog --recursive --ignore-directories=__pycache__ --ignore-directories=.git --patterns="*.py" --command="make auto-fix && make auto-check" app/

# API Documentation commands
api-docs:
	@echo "ğŸ“š ì—­í• ë³„ API ë¬¸ì„œ ì—…ë°ì´íŠ¸..."
	./scripts/update_api_docs.sh

api-test:
	@echo "ğŸ§ª ì£¼ìš” API ì—”ë“œí¬ì¸íŠ¸ í…ŒìŠ¤íŠ¸..."
	@curl -s http://localhost:8000/health | jq '.status' || echo "âŒ Health check ì‹¤íŒ¨"
	@curl -s http://localhost:8000/api/v1/simple-energy/providers | jq '.success' || echo "âŒ Simple Energy ì‹¤íŒ¨"
	@echo "âœ… API í…ŒìŠ¤íŠ¸ ì™„ë£Œ"

# Frontend Development Support Commands
frontend-help:
	@echo "ğŸ¯ í”„ë¡ íŠ¸ì—”ë“œ ê°œë°œìë¥¼ ìœ„í•œ ê°€ì´ë“œ"
	@echo "=============================================="
	@echo ""
	@echo "ğŸ” Super Admin Dashboard (í¬íŠ¸ 3020):"
	@echo "   ğŸ“š API ë¬¸ì„œ: http://localhost:8000/api/v1/admin/docs"
	@echo "   ğŸ“„ OpenAPI: http://localhost:8000/api/v1/admin/openapi.json"
	@echo "   ğŸ“ TypeScript: frontend/super-admin-dashboard/src/lib/api-client.ts"
	@echo "   ğŸ“ ì˜ˆì œ ì½”ë“œ: frontend/super-admin-dashboard/src/examples/"
	@echo ""
	@echo "ğŸ”— Partner Admin Template (í¬íŠ¸ 3030):"
	@echo "   ğŸ“š API ë¬¸ì„œ: http://localhost:8000/api/v1/partner/docs"
	@echo "   ğŸ“„ OpenAPI: http://localhost:8000/api/v1/partner/openapi.json"
	@echo "   ğŸ“ TypeScript: frontend/partner-admin-template/src/lib/api-client.ts"
	@echo "   ğŸ“ ì˜ˆì œ ì½”ë“œ: frontend/partner-admin-template/src/examples/"
	@echo ""
	@echo "ğŸŒŸ ê°œë°œ/í…ŒìŠ¤íŠ¸ìš© API:"
	@echo "   ğŸ“š API ë¬¸ì„œ: http://localhost:8000/api/v1/dev/docs"
	@echo "   ğŸ“„ OpenAPI: http://localhost:8000/api/v1/dev/openapi.json"
	@echo ""
	@echo "ğŸ”§ ê°œë°œ ë„êµ¬:"
	@echo "   make dev-server      - ë°±ì—”ë“œ ì„œë²„ ì‹¤í–‰"
	@echo "   make frontend-test   - ì „ì²´ API ì—°ê²° í…ŒìŠ¤íŠ¸"
	@echo "   make update-api-docs - API ë¬¸ì„œ ë° íƒ€ì… ì—…ë°ì´íŠ¸"
	@echo "   make generate-api-types - TypeScript íƒ€ì… ìƒì„±"

dev-server:
	@echo "ğŸš€ ë°±ì—”ë“œ ê°œë°œ ì„œë²„ ì‹œì‘..."
	@echo "Super Admin API: http://localhost:8000/api/v1/admin/docs"
	@echo "Partner Admin API: http://localhost:8000/api/v1/partner/docs"
	@echo "ê°œë°œìš© API: http://localhost:8000/api/v1/dev/docs"
	@echo ""
	poetry run uvicorn app.main:app --reload --host 0.0.0.0 --port 8000

frontend-test:
	@echo "ğŸ§ª í”„ë¡ íŠ¸ì—”ë“œ-ë°±ì—”ë“œ API ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹¤í–‰..."
	./test_frontend_requests.sh

frontend-test-super-admin:
	@echo "ğŸ” Super Admin APIë§Œ í…ŒìŠ¤íŠ¸..."
	./test_frontend_requests.sh super-admin

frontend-test-partner-admin:
	@echo "ğŸ”— Partner Admin APIë§Œ í…ŒìŠ¤íŠ¸..."
	./test_frontend_requests.sh partner-admin

update-api-docs:
	@echo "ğŸ“š API ë¬¸ì„œ ë° TypeScript íƒ€ì… ì—…ë°ì´íŠ¸..."
	./scripts/update_api_docs.sh
	@echo "âœ… ì—…ë°ì´íŠ¸ ì™„ë£Œ!"

generate-api-types:
	@echo "ğŸ§ª TypeScript API íƒ€ì… ìƒì„±..."
	poetry run python scripts/generate_api_docs_by_role.py
	@echo "âœ… TypeScript íƒ€ì… ìƒì„± ì™„ë£Œ!"

frontend-dev-setup:
	@echo "ğŸš€ í”„ë¡ íŠ¸ì—”ë“œ ê°œë°œ í™˜ê²½ ì™„ì „ ì„¤ì •..."
	@make dev-server &
	@sleep 5
	@make frontend-test
	@echo "âœ… í”„ë¡ íŠ¸ì—”ë“œ ê°œë°œ í™˜ê²½ ì¤€ë¹„ ì™„ë£Œ!"
	@echo ""
	@echo "ğŸ“‹ ë‹¤ìŒ ë‹¨ê³„:"
	@echo "1. Super Admin: cd frontend/super-admin-dashboard && npm run dev"
	@echo "2. Partner Admin: cd frontend/partner-admin-template && npm run dev"

monitor-api:
	@echo "ğŸ“Š ì‹¤ì‹œê°„ API ëª¨ë‹ˆí„°ë§ ì‹œì‘..."
	./monitor_api_requests.sh

check-backend-status:
	@echo "ğŸ” ë°±ì—”ë“œ ìƒíƒœ í™•ì¸..."
	@curl -s http://localhost:8000/health | jq '.' && echo "âœ… ë°±ì—”ë“œ ì •ìƒ" || echo "âŒ ë°±ì—”ë“œ ë¬¸ì œ"
	@curl -s http://localhost:8000/ | jq '.api_docs' && echo "âœ… API ë¬¸ì„œ ì ‘ê·¼ ê°€ëŠ¥" || echo "âŒ API ë¬¸ì„œ ë¬¸ì œ"

# í†µí•© ê°œë°œ ì›Œí¬í”Œë¡œìš°
full-dev-setup: install pre-dev dev-server
	@echo "ğŸ‰ ì™„ì „í•œ ê°œë°œ í™˜ê²½ ì„¤ì • ì™„ë£Œ!"

frontend-ready: check-backend-status update-api-docs frontend-test
	@echo "ğŸ¯ í”„ë¡ íŠ¸ì—”ë“œ ê°œë°œ ì¤€ë¹„ ì™„ë£Œ!"
	@echo ""
	@echo "ğŸ“‹ í”„ë¡ íŠ¸ì—”ë“œ íŒ€ì„ ìœ„í•œ ì²´í¬ë¦¬ìŠ¤íŠ¸:"
	@echo "âœ… ë°±ì—”ë“œ ì„œë²„ ì‹¤í–‰ ì¤‘"
	@echo "âœ… API ë¬¸ì„œ ì—…ë°ì´íŠ¸ë¨"
	@echo "âœ… TypeScript íƒ€ì… ìƒì„±ë¨"
	@echo "âœ… API ì—°ê²° í…ŒìŠ¤íŠ¸ í†µê³¼"
	@echo ""
	@echo "ğŸš€ ì´ì œ í”„ë¡ íŠ¸ì—”ë“œ ê°œë°œì„ ì‹œì‘í•˜ì„¸ìš”!"

# íŒŒì¼ ì •ë¦¬ ëª…ë ¹ì–´ë“¤
clean-empty:
	@echo "ğŸ§¹ ë¹ˆ íŒŒì¼ ì •ë¦¬ ì¤‘..."
	python scripts/prevent_empty_files.py --cleanup

clean-empty-force:
	@echo "ğŸ§¹ ë¹ˆ íŒŒì¼ ê°•ì œ ì •ë¦¬ ì¤‘..."
	find . -type f -size 0 \
		-not -path "./.venv/*" \
		-not -path "./.git/*" \
		-not -path "./__pycache__/*" \
		-not -path "./.pytest_cache/*" \
		-not -path "./logs/*" \
		-not -path "./backups/*" \
		-not -path "./archive/*" \
		-delete 2>/dev/null || true

prevent-empty:
	@echo "ğŸ›¡ï¸ ë¹ˆ íŒŒì¼ ìƒì„± ë°©ì§€ ëª¨ë‹ˆí„°ë§ ì‹œì‘..."
	python scripts/prevent_empty_files.py --monitor

prevent-empty-check:
	@echo "ğŸ” ë¹ˆ íŒŒì¼ ê²€ì‚¬ ì¤‘..."
	python scripts/prevent_empty_files.py
	@echo "âœ… ë¹ˆ íŒŒì¼ ì •ë¦¬ ì™„ë£Œ"

clean-temp:
	@echo "ğŸ§¹ ì„ì‹œ íŒŒì¼ ì •ë¦¬ ì¤‘..."
	find . -name "*.tmp" -o -name "*.temp" -o -name "*.backup" | grep -v ".venv" | xargs rm -f 2>/dev/null || true
	@echo "âœ… ì„ì‹œ íŒŒì¼ ì •ë¦¬ ì™„ë£Œ"

clean-all: clean clean-empty clean-temp
	@echo "ğŸ§¹ ì „ì²´ ì •ë¦¬ ì™„ë£Œ!"

# ë¹ˆ íŒŒì¼ ë°©ì§€ ì•ˆì „ ê°€ë“œ
safe-update-docs:
	@echo "ğŸ›¡ï¸ ì•ˆì „í•œ API ë¬¸ì„œ ì—…ë°ì´íŠ¸..."
	@make check-backend-status
	@make clean-empty
	@make update-api-docs
	@make clean-empty
	@echo "âœ… ì•ˆì „í•œ ë¬¸ì„œ ì—…ë°ì´íŠ¸ ì™„ë£Œ"
