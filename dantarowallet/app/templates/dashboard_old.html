{% extends "base.html" %}

{% block title %}대시보드 - 단타로 월렛 프로{% endblock %}

{% block content %}
<div class="row">
    <!-- 좌측 사이드바 -->
    <div class="col-md-3">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-user me-2"></i>사용자 정보</h5>
            </div>
            <div class="card-body">
                <div class="text-center mb-3">
                    <div class="avatar-circle bg-primary text-white">
                        <i class="fas fa-user fa-2x"></i>
                    </div>
                    <h6 class="mt-2">{{ current_user.email }}</h6>
                    <small class="text-muted">가입일: {{ current_user.created_at.strftime('%Y-%m-%d') }}</small>
                </div>

                <div class="d-grid gap-2">
                    <a href="/wallet" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-wallet me-1"></i>지갑 관리
                    </a>
                    <a href="/transactions" class="btn btn-outline-info btn-sm">
                        <i class="fas fa-list me-1"></i>거래내역
                    </a>
                    <a href="/settings" class="btn btn-outline-secondary btn-sm">
                        <i class="fas fa-cog me-1"></i>설정
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- 메인 콘텐츠 -->
    <div class="col-md-9">
        <!-- 잔고 카드 -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card bg-gradient-primary text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h5 class="card-title">TRX 잔고</h5>
                                <h3 class="mb-0">{{ balance.trx_balance or 0 }} TRX</h3>
                                <small class="opacity-75">≈ ${{ (balance.trx_balance or 0) * trx_price }}</small>
                            </div>
                            <div class="text-end">
                                <i class="fas fa-coins fa-3x opacity-50"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card bg-gradient-success text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h5 class="card-title">USDT 잔고</h5>
                                <h3 class="mb-0">{{ balance.usdt_balance or 0 }} USDT</h3>
                                <small class="opacity-75">≈ ${{ balance.usdt_balance or 0 }}</small>
                            </div>
                            <div class="text-end">
                                <i class="fas fa-dollar-sign fa-3x opacity-50"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 빠른 액션 -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-bolt me-2"></i>빠른 액션</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="d-grid">
                                    <button class="btn btn-success" onclick="showDepositModal()">
                                        <i class="fas fa-arrow-down me-1"></i>입금
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="d-grid">
                                    <button class="btn btn-warning" onclick="showWithdrawModal()">
                                        <i class="fas fa-arrow-up me-1"></i>출금
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="d-grid">
                                    <button class="btn btn-info" onclick="refreshBalance()">
                                        <i class="fas fa-sync me-1"></i>잔고 새로고침
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="d-grid">
                                    <a href="/transactions" class="btn btn-outline-primary">
                                        <i class="fas fa-history me-1"></i>거래내역
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 최근 거래 -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="fas fa-clock me-2"></i>최근 거래</h5>
                        <a href="/transactions" class="btn btn-sm btn-outline-primary">전체보기</a>
                    </div>
                    <div class="card-body">
                        {% if recent_transactions %}
                        <div class="transaction-list">
                            {% for tx in recent_transactions %}
                            <div class="transaction-item d-flex justify-content-between align-items-center py-2 border-bottom">
                                <div class="d-flex align-items-center">
                                    <div class="transaction-icon me-3">
                                        {% if tx.transaction_type == 'deposit' %}
                                        <i class="fas fa-arrow-down text-success"></i>
                                        {% elif tx.transaction_type == 'withdrawal' %}
                                        <i class="fas fa-arrow-up text-warning"></i>
                                        {% else %}
                                        <i class="fas fa-exchange-alt text-info"></i>
                                        {% endif %}
                                    </div>
                                    <div>
                                        <div class="fw-bold">{{ tx.transaction_type.title() }}</div>
                                        <small class="text-muted">{{ tx.created_at.strftime('%Y-%m-%d %H:%M') }}</small>
                                    </div>
                                </div>
                                <div class="text-end">
                                    <div class="fw-bold">
                                        {% if tx.transaction_type == 'deposit' %}+{% elif tx.transaction_type == 'withdrawal' %}-{% endif %}
                                        {{ tx.amount }} {{ tx.asset_type }}
                                    </div>
                                    <small class="text-muted">{{ tx.status }}</small>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                            <p class="text-muted">아직 거래 내역이 없습니다.</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- 차트 -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-line me-2"></i>잔고 변화</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="balanceChart" height="200"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 입금 모달 -->
<div class="modal fade" id="depositModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">입금하기</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="text-center">
                    <p>아래 주소로 USDT 또는 TRX를 송금하세요:</p>
                    <div class="card bg-light p-3">
                        <h6>입금 주소</h6>
                        <div class="d-flex align-items-center">
                            <input type="text" class="form-control" id="depositAddress" value="{{ wallet_address }}" readonly>
                            <button class="btn btn-outline-primary ms-2" onclick="copyToClipboard('depositAddress')">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                    </div>
                    <div class="mt-3">
                        <small class="text-muted">
                            입금이 완료되면 자동으로 잔고에 반영됩니다.<br>
                            최소 3회 컨펌 후 사용 가능합니다.
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 출금 모달 -->
<div class="modal fade" id="withdrawModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">출금하기</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="withdrawForm">
                    <div class="mb-3">
                        <label for="assetType" class="form-label">자산 유형</label>
                        <select class="form-select" id="assetType" required>
                            <option value="">선택하세요</option>
                            <option value="TRX">TRX</option>
                            <option value="USDT">USDT</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="toAddress" class="form-label">받는 주소</label>
                        <input type="text" class="form-control" id="toAddress" required>
                    </div>
                    <div class="mb-3">
                        <label for="amount" class="form-label">금액</label>
                        <input type="number" class="form-control" id="amount" step="0.000001" required>
                    </div>
                    <div class="mb-3">
                        <small class="text-muted">
                            출금 수수료: TRX 1개, USDT 1개<br>
                            출금은 관리자 승인 후 처리됩니다.
                        </small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                <button type="button" class="btn btn-warning" onclick="submitWithdraw()">출금 신청</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// 잔고 데이터 초기화
const balanceHistoryData = {
    dates: {{ balance_history.dates | tojson | safe }},
    trx_values: {{ balance_history.trx_values | tojson | safe }},
    usdt_values: {{ balance_history.usdt_values | tojson | safe }}
};

// 잔고 차트 생성
const ctx = document.getElementById('balanceChart').getContext('2d');
const balanceChart = new Chart(ctx, {
    type: 'line',
    data: {
        labels: balanceHistoryData.dates,
        datasets: [{
            label: 'TRX',
            data: balanceHistoryData.trx_values,
            borderColor: 'rgb(75, 192, 192)',
            tension: 0.1
        }, {
            label: 'USDT',
            data: balanceHistoryData.usdt_values,
            borderColor: 'rgb(255, 99, 132)',
            tension: 0.1
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'top',
            },
            title: {
                display: true,
                text: '최근 7일 잔고 변화'
            }
        }
    }
});

// 모달 함수들
function showDepositModal() {
    new bootstrap.Modal(document.getElementById('depositModal')).show();
}

function showWithdrawModal() {
    new bootstrap.Modal(document.getElementById('withdrawModal')).show();
}

function copyToClipboard(elementId) {
    const element = document.getElementById(elementId);
    element.select();
    document.execCommand('copy');
    alert('주소가 복사되었습니다!');
}

function refreshBalance() {
    location.reload();
}

function submitWithdraw() {
    const form = document.getElementById('withdrawForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }

    const data = {
        asset_type: document.getElementById('assetType').value,
        to_address: document.getElementById('toAddress').value,
        amount: parseFloat(document.getElementById('amount').value)
    };

    fetch('/api/v1/withdrawals/request', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + localStorage.getItem('token')
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('출금 신청이 완료되었습니다. 관리자 승인 후 처리됩니다.');
            bootstrap.Modal.getInstance(document.getElementById('withdrawModal')).hide();
            location.reload();
        } else {
            alert('출금 신청 중 오류가 발생했습니다: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('출금 신청 중 오류가 발생했습니다.');
    });
}
</script>
{% endblock %}
