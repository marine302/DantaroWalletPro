<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TronLink ì§€ê°‘ ì—°ë™ - DantaroWallet</title>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            max-width: 500px;
            width: 90%;
        }
        
        .header {
            text-align: center;
            margin-bottom: 2rem;
        }
        
        .header h1 {
            color: #333;
            margin-bottom: 0.5rem;
        }
        
        .header p {
            color: #666;
            font-size: 0.9rem;
        }
        
        .wallet-status {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1.5rem;
            text-align: center;
        }
        
        .status-connected {
            background: #d4edda;
            color: #155724;
        }
        
        .status-disconnected {
            background: #f8d7da;
            color: #721c24;
        }
        
        .btn {
            width: 100%;
            padding: 0.8rem;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: #007bff;
            color: white;
        }
        
        .btn-primary:hover {
            background: #0056b3;
            transform: translateY(-2px);
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }
        
        .wallet-info {
            background: #e9ecef;
            border-radius: 10px;
            padding: 1rem;
            margin: 1rem 0;
        }
        
        .wallet-info h3 {
            margin-bottom: 0.5rem;
            color: #333;
        }
        
        .wallet-address {
            font-family: 'Courier New', monospace;
            background: white;
            padding: 0.5rem;
            border-radius: 5px;
            word-break: break-all;
            font-size: 0.8rem;
        }
        
        .balance-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .balance-item {
            text-align: center;
            background: white;
            padding: 1rem;
            border-radius: 8px;
        }
        
        .balance-amount {
            font-size: 1.2rem;
            font-weight: bold;
            color: #007bff;
        }
        
        .balance-label {
            font-size: 0.8rem;
            color: #666;
            margin-top: 0.2rem;
        }
        
        .loading {
            display: none;
            text-align: center;
            color: #666;
            margin: 1rem 0;
        }
        
        .spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #007bff;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 0.5rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 0.8rem;
            border-radius: 5px;
            margin: 1rem 0;
            display: none;
        }
        
        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 0.8rem;
            border-radius: 5px;
            margin: 1rem 0;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¦ TronLink ì—°ë™</h1>
            <p>TronLink ì§€ê°‘ì„ ì—°ê²°í•˜ì—¬ USDT ê±°ë˜ë¥¼ ì‹œì‘í•˜ì„¸ìš”</p>
        </div>
        
        <div id="wallet-status" class="wallet-status status-disconnected">
            <strong>ì§€ê°‘ì´ ì—°ê²°ë˜ì§€ ì•ŠìŒ</strong>
            <p>TronLinkë¥¼ ì„¤ì¹˜í•˜ê³  ì§€ê°‘ì„ ì—°ê²°í•´ì£¼ì„¸ìš”</p>
        </div>
        
        <div class="error-message" id="error-message"></div>
        <div class="success-message" id="success-message"></div>
        <div class="loading" id="loading">
            <span class="spinner"></span>
            ì²˜ë¦¬ ì¤‘...
        </div>
        
        <button id="connect-btn" class="btn btn-primary" onclick="connectWallet()">
            TronLink ì—°ê²°í•˜ê¸°
        </button>
        
        <button id="disconnect-btn" class="btn btn-danger" onclick="disconnectWallet()" style="display: none;">
            ì§€ê°‘ ì—°ê²° í•´ì œ
        </button>
        
        <div id="wallet-info" class="wallet-info" style="display: none;">
            <h3>ì—°ê²°ëœ ì§€ê°‘</h3>
            <div id="wallet-address" class="wallet-address"></div>
            
            <div class="balance-info">
                <div class="balance-item">
                    <div id="trx-balance" class="balance-amount">0.00</div>
                    <div class="balance-label">TRX</div>
                </div>
                <div class="balance-item">
                    <div id="usdt-balance" class="balance-amount">0.00</div>
                    <div class="balance-label">USDT</div>
                </div>
            </div>
            
            <button class="btn btn-primary" onclick="refreshBalance()" style="margin-top: 1rem;">
                ì”ì•¡ ìƒˆë¡œê³ ì¹¨
            </button>
        </div>
    </div>

    <script>
        let currentWallet = null;
        let currentWalletId = null;
        
        // í˜ì´ì§€ ë¡œë“œì‹œ ìƒíƒœ í™•ì¸
        window.onload = function() {
            checkTronLinkInstallation();
            loadWalletStatus();
        };
        
        function checkTronLinkInstallation() {
            if (typeof window.tronWeb === 'undefined') {
                showError('TronLinkê°€ ì„¤ì¹˜ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € í™•ì¥í”„ë¡œê·¸ë¨ì„ ì„¤ì¹˜í•´ì£¼ì„¸ìš”.');
                document.getElementById('connect-btn').disabled = true;
                return false;
            }
            return true;
        }
        
        async function connectWallet() {
            if (!checkTronLinkInstallation()) return;
            
            showLoading(true);
            hideMessages();
            
            try {
                // TronLink ì§€ê°‘ ì£¼ì†Œ ê°€ì ¸ì˜¤ê¸°
                const tronWeb = window.tronWeb;
                if (!tronWeb.ready) {
                    throw new Error('TronLinkê°€ ì ê²¨ìˆìŠµë‹ˆë‹¤. ì§€ê°‘ì„ ì ê¸ˆí•´ì œí•´ì£¼ì„¸ìš”.');
                }
                
                const address = tronWeb.defaultAddress.base58;
                if (!address) {
                    throw new Error('ì§€ê°‘ ì£¼ì†Œë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
                
                // ì„œëª…ì„ ìœ„í•œ ë©”ì‹œì§€ ìƒì„±
                const timestamp = Date.now();
                const message = `DantaroWallet ì§€ê°‘ ì—°ê²° ì¸ì¦\nì‹œê°„: ${new Date(timestamp).toISOString()}`;
                
                // ë©”ì‹œì§€ ì„œëª…
                const signature = await tronWeb.trx.sign(message);
                
                // ì„œë²„ì— ì—°ê²° ìš”ì²­
                const response = await axios.post('/api/v1/tronlink/connect', {
                    wallet_address: address,
                    signature: signature,
                    message: message
                });
                
                currentWallet = address;
                currentWalletId = response.data.wallet_id;
                
                showSuccess(response.data.message);
                updateWalletStatus(true);
                await loadWalletBalance();
                
            } catch (error) {
                console.error('ì—°ê²° ì˜¤ë¥˜:', error);
                showError(error.response?.data?.detail || error.message || 'ì§€ê°‘ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            } finally {
                showLoading(false);
            }
        }
        
        async function disconnectWallet() {
            if (!currentWalletId) return;
            
            showLoading(true);
            hideMessages();
            
            try {
                await axios.post('/api/v1/tronlink/disconnect', {
                    wallet_id: currentWalletId
                });
                
                currentWallet = null;
                currentWalletId = null;
                
                showSuccess('ì§€ê°‘ ì—°ê²°ì´ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                updateWalletStatus(false);
                
            } catch (error) {
                console.error('ì—°ê²° í•´ì œ ì˜¤ë¥˜:', error);
                showError(error.response?.data?.detail || 'ì—°ê²° í•´ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            } finally {
                showLoading(false);
            }
        }
        
        async function loadWalletStatus() {
            try {
                const response = await axios.get('/api/v1/tronlink/status');
                const status = response.data;
                
                if (status.is_connected && status.wallet_count > 0) {
                    const walletsResponse = await axios.get('/api/v1/tronlink/wallets');
                    const wallets = walletsResponse.data.wallets;
                    
                    if (wallets.length > 0) {
                        const wallet = wallets[0];
                        currentWallet = wallet.address;
                        currentWalletId = wallet.id;
                        updateWalletStatus(true);
                        updateWalletInfo(wallet);
                    }
                }
            } catch (error) {
                console.error('ìƒíƒœ ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }
        
        async function loadWalletBalance() {
            if (!currentWallet) return;
            
            try {
                const response = await axios.get(`/api/v1/tronlink/wallet/${currentWallet}/balance`);
                const balance = response.data;
                
                document.getElementById('trx-balance').textContent = balance.trx_balance.toFixed(2);
                document.getElementById('usdt-balance').textContent = balance.usdt_balance.toFixed(2);
                
            } catch (error) {
                console.error('ì”ì•¡ ë¡œë“œ ì˜¤ë¥˜:', error);
                showError('ì”ì•¡ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }
        }
        
        async function refreshBalance() {
            showLoading(true);
            await loadWalletBalance();
            showLoading(false);
            showSuccess('ì”ì•¡ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }
        
        function updateWalletStatus(connected) {
            const statusDiv = document.getElementById('wallet-status');
            const connectBtn = document.getElementById('connect-btn');
            const disconnectBtn = document.getElementById('disconnect-btn');
            const walletInfo = document.getElementById('wallet-info');
            
            if (connected) {
                statusDiv.className = 'wallet-status status-connected';
                statusDiv.innerHTML = '<strong>ì§€ê°‘ ì—°ê²°ë¨</strong><p>TronLink ì§€ê°‘ì´ ì„±ê³µì ìœ¼ë¡œ ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤</p>';
                connectBtn.style.display = 'none';
                disconnectBtn.style.display = 'block';
                walletInfo.style.display = 'block';
            } else {
                statusDiv.className = 'wallet-status status-disconnected';
                statusDiv.innerHTML = '<strong>ì§€ê°‘ì´ ì—°ê²°ë˜ì§€ ì•ŠìŒ</strong><p>TronLinkë¥¼ ì„¤ì¹˜í•˜ê³  ì§€ê°‘ì„ ì—°ê²°í•´ì£¼ì„¸ìš”</p>';
                connectBtn.style.display = 'block';
                disconnectBtn.style.display = 'none';
                walletInfo.style.display = 'none';
            }
        }
        
        function updateWalletInfo(wallet) {
            document.getElementById('wallet-address').textContent = wallet.address;
            document.getElementById('trx-balance').textContent = wallet.balance.trx_balance.toFixed(2);
            document.getElementById('usdt-balance').textContent = wallet.balance.usdt_balance.toFixed(2);
        }
        
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }
        
        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }
        
        function showSuccess(message) {
            const successDiv = document.getElementById('success-message');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
        }
        
        function hideMessages() {
            document.getElementById('error-message').style.display = 'none';
            document.getElementById('success-message').style.display = 'none';
        }
    </script>
</body>
</html>
