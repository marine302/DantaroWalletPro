# 트론 에너지 대납 서비스 기능 명세서

## 1. 시스템 개요

중앙집중식 USDT 지갑 서비스에서 사용자의 USDT 출금 시 필요한 트론 에너지를 대납하는 B2B 서비스입니다.

## 2. 주요 참여자 역할

### 2.1 본사 (에너지 관리 서비스)
- 멀티 에너지 공급원 관리 (자체 스테이킹 + 외부 공급사)
- 최적 공급원 자동 선택 알고리즘 운영
- 파트너사별 에너지 사용량 계산
- TRX 수신 및 에너지 구매/위임 처리
- 자체 스테이킹 지갑 관리 및 운영
- 마진 관리 및 정산
- API 제공 및 시스템 운영
- 점진적 자체 스테이킹 풀 확대

### 2.2 파트너사 (지갑 서비스 운영사)
- 사용자 USDT 지갑 서비스 운영
- 콜드 월렛 및 핫 월렛 관리
- 사용자 출금 요청 수집 및 승인
- 출금 배치 처리 및 트랜잭션 서명
- 사용자로부터 USDT 수수료 징수
- 본사에 TRX 비용 지불

### 2.3 사용자
- 파트너사 서비스에 USDT 입금
- 외부 주소로 USDT 출금 요청
- 출금 수수료 지불 (USDT)

## 3. 전체 워크플로우

### 3.1 사용자 입금 프로세스
```
1. 사용자가 파트너사 서비스에서 개인 지갑 주소 생성
2. 해당 주소로 USDT 입금
3. 파트너사가 스윕(Sweep) 기능으로 콜드 월렛으로 이동
4. 사용자 잔액은 DB에 기록, UI에는 숫자로만 표시
```

### 3.2 파트너사 지갑 구조
```
콜드 월렛 (자금 보관용)
├── 사용자 USDT 총액 보관
├── 해킹 리스크 최소화
└── 출금 시 핫 월렛으로 이동

핫 월렛 (출금 운영용)  
├── 실제 출금 트랜잭션 실행
├── TRX 보유 (가스비/수수료용)
├── 에너지 수신 주소
└── 트론링크/레저 등으로 관리
```

### 3.3 사용자 출금 프로세스
```
1. 사용자가 출금 요청 (금액, 수신 주소 입력)
2. 파트너사가 출금 요청 검토 및 1차 승인
3. 승인된 출금 요청을 큐에 등록
4. 콜드 월렛 → 핫 월렛으로 필요 USDT 이동
5. 출금 유형에 따라 처리:
   - 즉시 출금: 30분 이내 처리
   - 일반 출금: 2시간 이내 처리  
   - 정기 출금: 지정 시간 배치 처리 (예: 10:30, 16:30)
6. 트랜잭션 생성 및 서명 요청
7. 파트너사 운영자가 지갑에서 최종 승인 (트론링크/레저)
8. 트랜잭션 브로드캐스트 및 완료
```

### 3.4 에너지 대납 프로세스
```
1. 파트너사가 출금 큐 확인
2. 필요 에너지 계산 요청 (본사 API 호출)
3. 본사가 에너지 비용 계산 및 응답
   - 기본 비용 = 필요 에너지 × 현재 시세
   - 총 비용 = 기본 비용 + 마진 (15-20%)
   - SaaS 수수료 = 건당 1 TRX (설정 가능)
4. 파트너사가 본사에 TRX 송금 (핫 월렛에서)
   - 에너지 비용 + SaaS 수수료
5. 본사가 TRX 수신 확인
6. 본사가 최적 공급원 선택:
   a. 자체 스테이킹 에너지 확인 (가장 저렴)
   b. 외부 공급사 1 (TronZap) 확인
   c. 외부 공급사 2 (TronNRG) 확인
   d. 모든 공급원 실패 시 → 파트너사 직접 처리 모드
7. 선택된 공급원에서 에너지 확보:
   - 자체: 직접 위임
   - 외부: API/스마트컨트랙트로 구매
   - 실패: 파트너사에 직접 처리 알림
8. 파트너사 핫 월렛에 에너지 위임 완료
9. 파트너사가 핫 월렛에서 사용자 지정 주소로 USDT 전송
   - 트랜잭션 생성
   - 운영자 서명 (트론링크/레저)
   - 브로드캐스트
```

### 3.5 에너지 공급 실패 시 폴백 프로세스
```
1. 본사가 모든 에너지 공급원 실패 감지
2. 파트너사에 즉시 알림 발송
3. 파트너사 직접 처리 모드 활성화:
   - 출금 건별 예상 TRX 소각량 계산
   - 파트너사 핫 월렛 TRX 잔액 확인
   - 충분한 TRX 보유 시 직접 출금 진행
4. 정산 처리:
   - 실제 소각된 TRX 기록
   - 다음 정산 시 차감 또는 환불
```

### 3.7 본사 지갑 구조
```
수익금 수신 지갑 (Revenue Wallet)
├── 파트너사로부터 TRX 수신
├── 에너지 비용 + SaaS 수수료
└── 일일 정산 관리

스테이킹 지갑 (Staking Wallet)
├── 자체 에너지 생산용
├── TRX 스테이킹 (freezeBalanceV2)
├── 에너지 위임 관리
└── 프로그래밍 방식 제어

운영비 지갑 (Operating Wallet)
├── 외부 공급사 결제
├── 환불 처리
└── 일일 운영 자금
```

### 3.8 본사 스테이킹 프로세스
```
1. 수익금 누적 확인
2. 재투자 비율 계산 (월 수익의 50%)
3. 스테이킹 지갑으로 TRX 이동
4. API를 통한 자동 스테이킹:
   - freezeBalanceV2 호출
   - 리소스 타입: ENERGY
   - 스테이킹 기간: 무기한
5. 생성된 에너지 모니터링
6. 파트너사 요청 시 에너지 위임
```

## 4. 핵심 기능 상세

### 4.1 에너지 계산 API

**요청 (파트너사 → 본사)**
```json
{
  "partner_id": "PTR_001",
  "withdrawal_requests": [
    {
      "request_id": "WD_12345",
      "amount": 100,
      "to_address": "TRx1234...",
      "type": "immediate"
    }
  ],
  "batch_mode": false
}
```

**응답 (본사 → 파트너사)**
```json
{
  "total_energy_required": 32000,
  "base_cost_trx": 0.64,
  "margin_trx": 0.128,
  "saas_fee_trx": 1.0,
  "total_cost_trx": 1.768,
  "energy_price": 0.00002,
  "fallback_burn_trx": 13.2,
  "valid_until": "2024-01-01T10:30:00Z"
}
```

### 4.2 SaaS 수수료 설정 API

**요청 (본사 관리자)**
```json
{
  "partner_id": "PTR_001",
  "fee_settings": {
    "per_transaction_fee": 1.0,
    "minimum_batch_fee": 5.0,
    "fee_type": "fixed"  // fixed, percentage, tiered
  }
}
```

### 4.2 에너지 충전 프로세스

**1단계: TRX 송금 확인**
```json
{
  "partner_id": "PTR_001",
  "trx_amount": 0.768,
  "tx_hash": "0x1234...",
  "reference_id": "ENERGY_REQ_001"
}
```

**2단계: 에너지 위임 요청**
```json
{
  "target_address": "파트너사_운영자_지갑_주소",
  "energy_amount": 32000,
  "duration": 1,  // days
  "supplier_request_id": "SUP_REQ_001"
}
```

**3단계: 위임 완료 확인**
```json
{
  "delegation_tx_hash": "0x5678...",
  "delegated_energy": 32000,
  "expires_at": "2024-01-02T10:30:00Z",
  "status": "completed"
}
```

### 4.3 출금 배치 처리

**배치 그룹핑 로직**
```
IF 출금 요청 수 < 10 THEN
  개별 처리
  SaaS_수수료 = 요청_수 × 1 TRX
ELSE IF 긴급 출금 포함 THEN
  긴급 건만 분리하여 우선 처리
  나머지는 배치 처리
  SaaS_수수료 = 전체_요청_수 × 1 TRX
ELSE
  모든 요청을 하나의 배치로 처리
  SaaS_수수료 = MAX(전체_요청_수 × 1 TRX, 최소_배치_수수료)
END IF
```

**배치 처리 최적화**
- 동일 수신 주소 통합
- 연속된 소액 거래 병합
- 가스비 최적화를 위한 거래 순서 조정
- SaaS 수수료는 건별로 계산

### 4.4 운영자 지갑 에너지 관리

**에너지 잔량 모니터링**
```json
{
  "hot_wallet_address": "파트너사_핫_월렛",
  "cold_wallet_address": "파트너사_콜드_월렛",
  "hot_wallet_usdt_balance": 10000,
  "hot_wallet_trx_balance": 500,
  "current_energy": 150000,
  "daily_average_usage": 480000,
  "estimated_depletion": "6 hours",
  "auto_recharge_threshold": 100000
}
```

**자동 충전 트리거**
```
IF 현재_에너지 < 자동충전_임계값 THEN
  예상_필요량 = 일평균_사용량 × 1.2
  충전_요청(예상_필요량)
END IF

IF 핫월렛_TRX < 최소_필요_TRX THEN
  알림_발송("TRX 부족 - 충전 필요")
END IF
```

### 4.5 멀티 에너지 공급원 관리

**공급원 우선순위 시스템**
```json
{
  "energy_sources": [
    {
      "type": "self_staking",
      "priority": 1,
      "available_energy": 500000,
      "cost_per_energy": 0.00001,
      "status": "active"
    },
    {
      "type": "external_api",
      "provider": "TronZap",
      "priority": 2,
      "api_status": "healthy",
      "cost_per_energy": 0.000018,
      "min_order": 65000
    },
    {
      "type": "external_api", 
      "provider": "TronNRG",
      "priority": 3,
      "api_status": "healthy",
      "cost_per_energy": 0.00002,
      "min_order": 32000
    }
  ]
}
```

**공급원 선택 알고리즘**
```
FUNCTION 최적_공급원_선택(필요_에너지):
  FOR EACH 공급원 IN 우선순위_순서:
    IF 공급원.type == "self_staking" AND 공급원.available_energy >= 필요_에너지:
      RETURN 공급원
    ELSE IF 공급원.type == "external_api" AND 공급원.api_status == "healthy":
      IF 필요_에너지 >= 공급원.min_order:
        RETURN 공급원
  END FOR
  
  // 모든 공급원 실패 시 파트너사 직접 처리
  RETURN {
    "type": "partner_direct",
    "fallback_mode": true,
    "estimated_burn_trx": 필요_에너지 × 0.000413
  }
```

### 4.6 자체 스테이킹 관리

**스테이킹 풀 상태**
```json
{
  "staking_wallet": "본사_스테이킹_지갑",
  "total_staked_trx": 100000,
  "daily_energy_generation": 150000000,
  "allocated_energy": 120000000,
  "available_energy": 30000000,
  "roi_percentage": 25.5
}
```

**점진적 스테이킹 증가 전략**
```
월간_수익 = 총_마진_수익
IF 월간_수익 > 최소_투자_기준:
  재투자_금액 = 월간_수익 × 0.5  // 수익의 50% 재투자
  추가_스테이킹(재투자_금액)
  
  // 자체 공급 비율 목표
  IF 자체_공급_비율 < 30%:
    목표 = "6개월 내 50% 달성"
  ELSE IF 자체_공급_비율 < 50%:
    목표 = "1년 내 70% 달성"
```

## 5. 데이터 흐름

### 5.1 실시간 데이터
- 에너지 시세 (5분 간격 업데이트)
- 파트너사별 에너지 잔량
- 출금 큐 상태
- TRX 잔액

### 5.2 배치 데이터
- 일별 사용량 통계
- 정산 데이터
- 비용 분석 리포트

## 6. 시스템 간 인터페이스

### 6.1 파트너사 → 본사
- 에너지 비용 조회 API
- 에너지 충전 요청 API
- 사용량 조회 API
- 정산 내역 조회 API

### 6.2 본사 → 에너지 공급사
- 에너지 가격 조회 API
- 에너지 위임 요청 API
- 위임 상태 확인 API

### 6.3 본사 → 파트너사
- 에너지 충전 완료 Webhook
- 일일 정산 리포트 Webhook
- 에너지 부족 경고 Webhook

## 7. 상태 관리

### 7.1 출금 요청 상태
```
PENDING → APPROVED → QUEUED → WALLET_FUNDED → PROCESSING → SIGNING → COMPLETED
                          ↓                              ↓
                      FAILED → RETRY              SIGNATURE_TIMEOUT → MANUAL
```

### 7.2 에너지 충전 상태
```
REQUESTED → PAYMENT_CONFIRMED → DELEGATING → COMPLETED
                              ↓
                          FAILED → PARTNER_DIRECT_MODE
```

### 7.3 파트너사 직접 처리 상태
```
ENERGY_REQUEST_FAILED → PARTNER_NOTIFIED → DIRECT_BURN_MODE
                                         ↓
                                    TRX_BURNED → RECONCILED
```

## 8. 에러 처리

### 8.1 에너지 부족
- 자동 긴급 충전 프로세스 실행
- 출금 요청을 다음 배치로 이동
- 파트너사에 알림 발송

### 8.2 트랜잭션 실패
- 3회 자동 재시도
- 실패 시 수동 처리 큐로 이동
- 상세 에러 로그 기록

### 8.3 공급사 장애
- 우선순위에 따라 다음 공급사로 자동 전환
- 자체 스테이킹 → TronZap → TronNRG → 파트너사 직접 처리
- 진행 중인 요청 보존
- 장애 복구 후 자동 재개

### 8.4 파트너사 직접 처리 모드
- 모든 에너지 공급원 실패 시 활성화
- 파트너사에 실시간 알림 및 예상 소각 TRX 통보
- 파트너사 승인 후 직접 TRX 소각으로 출금 처리
- 실제 소각량 기록 및 차후 정산