# Copilot ë¬¸ì„œ #29: íŒŒíŠ¸ë„ˆì‚¬ ì˜¨ë³´ë”© ìë™í™”

## ëª©í‘œ
ìƒˆ íŒŒíŠ¸ë„ˆì‚¬ì˜ ì™„ì „ ìë™í™”ëœ ì˜¨ë³´ë”© í”„ë¡œì„¸ìŠ¤ë¥¼ êµ¬ì¶•í•©ë‹ˆë‹¤. íŒŒíŠ¸ë„ˆ ê³„ì • ìë™ ìƒì„± ë° ì„¤ì •, TronLink ì§€ê°‘ ì—°ë™ ê°€ì´ë“œ, ì´ˆê¸° ì—ë„ˆì§€ í’€ ì„¤ì • ì§€ì›, API í‚¤ ë°œê¸‰ ë° ë³´ì•ˆ ì„¤ì •, í…œí”Œë¦¿ ë°°í¬ ìë™í™”, ì˜¨ë³´ë”© ì²´í¬ë¦¬ìŠ¤íŠ¸ ë° ê²€ì¦ì„ í¬í•¨í•œ í†µí•© ì‹œìŠ¤í…œì„ êµ¬í˜„í•©ë‹ˆë‹¤.

## ì „ì œ ì¡°ê±´
- Copilot ë¬¸ì„œ #24-28ì´ ì™„ë£Œë˜ì–´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤
- íŒŒíŠ¸ë„ˆì‚¬ ê´€ë¦¬ ì‹œìŠ¤í…œì´ êµ¬í˜„ë˜ì–´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤
- TronLink ì—°ë™ ì‹œìŠ¤í…œì´ ì‘ë™ ì¤‘ì´ì–´ì•¼ í•©ë‹ˆë‹¤
- ì—ë„ˆì§€ í’€ ë° ìˆ˜ìˆ˜ë£Œ ê´€ë¦¬ê°€ êµ¬í˜„ë˜ì–´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤

## ğŸ¯ ì˜¨ë³´ë”© ìë™í™” êµ¬ì¡°

### ğŸ“‹ ì˜¨ë³´ë”© í”„ë¡œì„¸ìŠ¤ í”Œë¡œìš°
```
íŒŒíŠ¸ë„ˆì‚¬ ì˜¨ë³´ë”© ìë™í™”
â”œâ”€â”€ ğŸ“ Step 1: íŒŒíŠ¸ë„ˆ ë“±ë¡
â”‚   â”œâ”€â”€ ê¸°ë³¸ ì •ë³´ ìˆ˜ì§‘
â”‚   â”œâ”€â”€ ê³„ì•½ ì¡°ê±´ í•©ì˜
â”‚   â”œâ”€â”€ ë²•ì  ë¬¸ì„œ ì„œëª…
â”‚   â””â”€â”€ ì´ˆê¸° ê²°ì œ ì²˜ë¦¬
â”œâ”€â”€ ğŸ” Step 2: ê³„ì • ìƒì„±
â”‚   â”œâ”€â”€ íŒŒíŠ¸ë„ˆ ê³„ì • ìƒì„±
â”‚   â”œâ”€â”€ ê´€ë¦¬ì ê³„ì • ì„¤ì •
â”‚   â”œâ”€â”€ API í‚¤/ì‹œí¬ë¦¿ ë°œê¸‰
â”‚   â””â”€â”€ ë³´ì•ˆ ì„¤ì • ì´ˆê¸°í™”
â”œâ”€â”€ ğŸ’¼ Step 3: ì§€ê°‘ ì„¤ì •
â”‚   â”œâ”€â”€ TronLink ì—°ë™ ê°€ì´ë“œ
â”‚   â”œâ”€â”€ ë©”ì¸ ì§€ê°‘ ë“±ë¡
â”‚   â”œâ”€â”€ ìš´ì˜ ì§€ê°‘ ì„¤ì •
â”‚   â””â”€â”€ ì§€ê°‘ ê²€ì¦ í…ŒìŠ¤íŠ¸
â”œâ”€â”€ âš¡ Step 4: ì‹œìŠ¤í…œ êµ¬ì„±
â”‚   â”œâ”€â”€ ì—ë„ˆì§€ í’€ ì •ì±… ì„¤ì •
â”‚   â”œâ”€â”€ ìˆ˜ìˆ˜ë£Œ êµ¬ì¡° ì„¤ì •
â”‚   â”œâ”€â”€ ì¶œê¸ˆ ì •ì±… êµ¬ì„±
â”‚   â””â”€â”€ ì•Œë¦¼ ì„¤ì •
â”œâ”€â”€ ğŸš€ Step 5: í…œí”Œë¦¿ ë°°í¬
â”‚   â”œâ”€â”€ ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ ìƒì„±
â”‚   â”œâ”€â”€ API ë¬¸ì„œ ì»¤ìŠ¤í„°ë§ˆì´ì§•
â”‚   â”œâ”€â”€ ë¸Œëœë”© ì ìš©
â”‚   â””â”€â”€ ìƒ˜í”Œ ë°ì´í„° ìƒì„±
â””â”€â”€ âœ… Step 6: ê²€ì¦ ë° í™œì„±í™”
    â”œâ”€â”€ ì‹œìŠ¤í…œ í†µí•© í…ŒìŠ¤íŠ¸
    â”œâ”€â”€ API ì—°ë™ ê²€ì¦
    â”œâ”€â”€ ë³´ì•ˆ ì²´í¬ë¦¬ìŠ¤íŠ¸
    â””â”€â”€ ë¼ì´ë¸Œ í™˜ê²½ í™œì„±í™”
```

## ğŸ› ï¸ êµ¬í˜„ ë‹¨ê³„

### Phase 1: ì˜¨ë³´ë”© ì›Œí¬í”Œë¡œìš° ì—”ì§„ (2ì¼)

#### 1.1 ì˜¨ë³´ë”© í”„ë¡œì„¸ìŠ¤ ëª¨ë¸
```python
# app/models/partner_onboarding.py
from sqlalchemy import Column, Integer, String, Boolean, DateTime, JSON, Enum, ForeignKey, Text
from sqlalchemy.orm import relationship
from datetime import datetime
import enum

class OnboardingStatus(enum.Enum):
    PENDING = "pending"              # ëŒ€ê¸° ì¤‘
    REGISTRATION = "registration"    # ë“±ë¡ ì§„í–‰
    ACCOUNT_SETUP = "account_setup" # ê³„ì • ì„¤ì •
    WALLET_SETUP = "wallet_setup"   # ì§€ê°‘ ì„¤ì •
    SYSTEM_CONFIG = "system_config" # ì‹œìŠ¤í…œ êµ¬ì„±
    DEPLOYMENT = "deployment"       # ë°°í¬ ì¤‘
    TESTING = "testing"            # í…ŒìŠ¤íŠ¸ ì¤‘
    COMPLETED = "completed"        # ì™„ë£Œ
    FAILED = "failed"              # ì‹¤íŒ¨

class PartnerOnboarding(Base):
    """íŒŒíŠ¸ë„ˆ ì˜¨ë³´ë”© í”„ë¡œì„¸ìŠ¤"""
    __tablename__ = "partner_onboardings"
    
    id = Column(Integer, primary_key=True)
    partner_id = Column(Integer, ForeignKey("partners.id"))
    status = Column(Enum(OnboardingStatus), default=OnboardingStatus.PENDING)
    
    # ì§„í–‰ ìƒíƒœ
    current_step = Column(Integer, default=1)
    total_steps = Column(Integer, default=6)
    progress_percentage = Column(Integer, default=0)
    
    # ë‹¨ê³„ë³„ ì™„ë£Œ ìƒíƒœ
    registration_completed = Column(Boolean, default=False)
    account_setup_completed = Column(Boolean, default=False)
    wallet_setup_completed = Column(Boolean, default=False)
    system_config_completed = Column(Boolean, default=False)
    deployment_completed = Column(Boolean, default=False)
    testing_completed = Column(Boolean, default=False)
    
    # ì„¤ì • ë°ì´í„°
    configuration_data = Column(JSON, default=dict)
    deployment_info = Column(JSON, default=dict)
    
    # íƒ€ì„ìŠ¤íƒ¬í”„
    started_at = Column(DateTime, default=datetime.utcnow)
    completed_at = Column(DateTime)
    
    # ê´€ê³„
    partner = relationship("Partner", back_populates="onboarding")
    steps = relationship("OnboardingStep", back_populates="onboarding")
    checklist = relationship("OnboardingChecklist", back_populates="onboarding")

class OnboardingStep(Base):
    """ì˜¨ë³´ë”© ë‹¨ê³„ ìƒì„¸"""
    __tablename__ = "onboarding_steps"
    
    id = Column(Integer, primary_key=True)
    onboarding_id = Column(Integer, ForeignKey("partner_onboardings.id"))
    step_number = Column(Integer, nullable=False)
    step_name = Column(String(100), nullable=False)
    status = Column(String(20), default="pending")
    
    # ì‹¤í–‰ ì •ë³´
    started_at = Column(DateTime)
    completed_at = Column(DateTime)
    error_message = Column(Text)
    result_data = Column(JSON)
    
    onboarding = relationship("PartnerOnboarding", back_populates="steps")

class OnboardingChecklist(Base):
    """ì˜¨ë³´ë”© ì²´í¬ë¦¬ìŠ¤íŠ¸"""
    __tablename__ = "onboarding_checklists"
    
    id = Column(Integer, primary_key=True)
    onboarding_id = Column(Integer, ForeignKey("partner_onboardings.id"))
    category = Column(String(50))  # "security", "integration", "compliance"
    item_name = Column(String(200))
    is_required = Column(Boolean, default=True)
    is_completed = Column(Boolean, default=False)
    completed_at = Column(DateTime)
    notes = Column(Text)
    
    onboarding = relationship("PartnerOnboarding", back_populates="checklist")
```

#### 1.2 ì˜¨ë³´ë”© ì›Œí¬í”Œë¡œìš° ì„œë¹„ìŠ¤
```python
# app/services/onboarding_workflow_service.py
from typing import Dict, List, Optional
from sqlalchemy.orm import Session
from app.models import (
    Partner, PartnerOnboarding, OnboardingStep,
    OnboardingChecklist, OnboardingStatus
)
from app.services.partner_service import PartnerService
from app.services.wallet_service import WalletService
from app.services.deployment_service import DeploymentService
from app.core.logging import get_logger
import asyncio

logger = get_logger(__name__)

class OnboardingWorkflowService:
    """ì˜¨ë³´ë”© ì›Œí¬í”Œë¡œìš° ê´€ë¦¬ ì„œë¹„ìŠ¤"""
    
    def __init__(
        self,
        db: Session,
        partner_service: PartnerService,
        wallet_service: WalletService,
        deployment_service: DeploymentService
    ):
        self.db = db
        self.partner_service = partner_service
        self.wallet_service = wallet_service
        self.deployment_service = deployment_service
        
        # ì˜¨ë³´ë”© ë‹¨ê³„ ì •ì˜
        self.steps = [
            {
                "number": 1,
                "name": "íŒŒíŠ¸ë„ˆ ë“±ë¡",
                "handler": self._handle_registration
            },
            {
                "number": 2,
                "name": "ê³„ì • ìƒì„±",
                "handler": self._handle_account_setup
            },
            {
                "number": 3,
                "name": "ì§€ê°‘ ì„¤ì •",
                "handler": self._handle_wallet_setup
            },
            {
                "number": 4,
                "name": "ì‹œìŠ¤í…œ êµ¬ì„±",
                "handler": self._handle_system_config
            },
            {
                "number": 5,
                "name": "í…œí”Œë¦¿ ë°°í¬",
                "handler": self._handle_deployment
            },
            {
                "number": 6,
                "name": "ê²€ì¦ ë° í™œì„±í™”",
                "handler": self._handle_testing
            }
        ]
    
    async def start_onboarding(
        self,
        partner_data: Dict
    ) -> PartnerOnboarding:
        """ì˜¨ë³´ë”© í”„ë¡œì„¸ìŠ¤ ì‹œì‘"""
        try:
            # íŒŒíŠ¸ë„ˆ ìƒì„±
            partner = await self.partner_service.create_partner(partner_data)
            
            # ì˜¨ë³´ë”© í”„ë¡œì„¸ìŠ¤ ìƒì„±
            onboarding = PartnerOnboarding(
                partner_id=partner.id,
                status=OnboardingStatus.REGISTRATION,
                configuration_data=partner_data
            )
            
            self.db.add(onboarding)
            self.db.flush()
            
            # ì˜¨ë³´ë”© ë‹¨ê³„ ìƒì„±
            for step in self.steps:
                step_record = OnboardingStep(
                    onboarding_id=onboarding.id,
                    step_number=step["number"],
                    step_name=step["name"]
                )
                self.db.add(step_record)
            
            # ì²´í¬ë¦¬ìŠ¤íŠ¸ ìƒì„±
            await self._create_checklist(onboarding.id)
            
            self.db.commit()
            
            # ì²« ë²ˆì§¸ ë‹¨ê³„ ì‹¤í–‰
            await self._execute_next_step(onboarding)
            
            return onboarding
            
        except Exception as e:
            logger.error(f"ì˜¨ë³´ë”© ì‹œì‘ ì‹¤íŒ¨: {e}")
            self.db.rollback()
            raise
    
    async def _execute_next_step(
        self,
        onboarding: PartnerOnboarding
    ):
        """ë‹¤ìŒ ë‹¨ê³„ ì‹¤í–‰"""
        try:
            current_step = self.steps[onboarding.current_step - 1]
            step_record = self.db.query(OnboardingStep).filter(
                OnboardingStep.onboarding_id == onboarding.id,
                OnboardingStep.step_number == onboarding.current_step
            ).first()
            
            # ë‹¨ê³„ ì‹œì‘
            step_record.status = "running"
            step_record.started_at = datetime.utcnow()
            self.db.commit()
            
            # í•¸ë“¤ëŸ¬ ì‹¤í–‰
            result = await current_step["handler"](onboarding)
            
            # ë‹¨ê³„ ì™„ë£Œ
            step_record.status = "completed"
            step_record.completed_at = datetime.utcnow()
            step_record.result_data = result
            
            # ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
            onboarding.progress_percentage = int(
                (onboarding.current_step / onboarding.total_steps) * 100
            )
            
            # ë‹¤ìŒ ë‹¨ê³„ë¡œ ì´ë™
            if onboarding.current_step < onboarding.total_steps:
                onboarding.current_step += 1
                await self._execute_next_step(onboarding)
            else:
                onboarding.status = OnboardingStatus.COMPLETED
                onboarding.completed_at = datetime.utcnow()
            
            self.db.commit()
            
        except Exception as e:
            logger.error(f"ë‹¨ê³„ ì‹¤í–‰ ì‹¤íŒ¨: {e}")
            step_record.status = "failed"
            step_record.error_message = str(e)
            onboarding.status = OnboardingStatus.FAILED
            self.db.commit()
            raise
    
    async def _handle_registration(
        self,
        onboarding: PartnerOnboarding
    ) -> Dict:
        """Step 1: íŒŒíŠ¸ë„ˆ ë“±ë¡ ì²˜ë¦¬"""
        partner = onboarding.partner
        
        # ê³„ì•½ ë¬¸ì„œ ìƒì„±
        contract_id = await self._generate_contract(partner)
        
        # ê²°ì œ ì •ë³´ ì„¤ì •
        payment_info = await self._setup_payment(partner)
        
        onboarding.registration_completed = True
        
        return {
            "contract_id": contract_id,
            "payment_info": payment_info
        }
    
    async def _handle_account_setup(
        self,
        onboarding: PartnerOnboarding
    ) -> Dict:
        """Step 2: ê³„ì • ìƒì„±"""
        partner = onboarding.partner
        
        # API í‚¤ ìƒì„±
        api_credentials = await self.partner_service.generate_api_credentials(
            partner.id
        )
        
        # ê´€ë¦¬ì ê³„ì • ìƒì„±
        admin_account = await self._create_admin_account(partner)
        
        # ë³´ì•ˆ ì„¤ì •
        security_config = await self._setup_security(partner)
        
        onboarding.account_setup_completed = True
        
        return {
            "api_key": api_credentials["api_key"],
            "admin_account": admin_account,
            "security_config": security_config
        }
    
    async def _handle_wallet_setup(
        self,
        onboarding: PartnerOnboarding
    ) -> Dict:
        """Step 3: ì§€ê°‘ ì„¤ì •"""
        partner = onboarding.partner
        
        # TronLink ì—°ë™ ê°€ì´ë“œ URL ìƒì„±
        guide_url = await self._generate_wallet_guide(partner)
        
        # ì§€ê°‘ ë“±ë¡ ëŒ€ê¸°
        wallet_info = await self._wait_for_wallet_registration(partner)
        
        # ì§€ê°‘ ê²€ì¦
        validation_result = await self.wallet_service.validate_partner_wallet(
            partner.id,
            wallet_info["address"]
        )
        
        onboarding.wallet_setup_completed = True
        
        return {
            "guide_url": guide_url,
            "wallet_address": wallet_info["address"],
            "validation": validation_result
        }
    
    async def _handle_system_config(
        self,
        onboarding: PartnerOnboarding
    ) -> Dict:
        """Step 4: ì‹œìŠ¤í…œ êµ¬ì„±"""
        partner = onboarding.partner
        
        # ì—ë„ˆì§€ í’€ ì •ì±… ì„¤ì •
        energy_policy = await self._setup_energy_policy(partner)
        
        # ìˆ˜ìˆ˜ë£Œ êµ¬ì¡° ì„¤ì •
        fee_structure = await self._setup_fee_structure(partner)
        
        # ì¶œê¸ˆ ì •ì±… ì„¤ì •
        withdrawal_policy = await self._setup_withdrawal_policy(partner)
        
        # ì•Œë¦¼ ì„¤ì •
        notification_config = await self._setup_notifications(partner)
        
        onboarding.system_config_completed = True
        
        return {
            "energy_policy": energy_policy,
            "fee_structure": fee_structure,
            "withdrawal_policy": withdrawal_policy,
            "notifications": notification_config
        }
    
    async def _handle_deployment(
        self,
        onboarding: PartnerOnboarding
    ) -> Dict:
        """Step 5: í…œí”Œë¦¿ ë°°í¬"""
        partner = onboarding.partner
        
        # ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ ë°°í¬
        dashboard_url = await self.deployment_service.deploy_admin_dashboard(
            partner.id
        )
        
        # API ë¬¸ì„œ ì»¤ìŠ¤í„°ë§ˆì´ì§•
        api_docs_url = await self.deployment_service.customize_api_docs(
            partner.id
        )
        
        # ë¸Œëœë”© ì ìš©
        branding_result = await self._apply_branding(partner)
        
        # ìƒ˜í”Œ ë°ì´í„° ìƒì„±
        sample_data = await self._create_sample_data(partner)
        
        onboarding.deployment_completed = True
        onboarding.deployment_info = {
            "dashboard_url": dashboard_url,
            "api_docs_url": api_docs_url,
            "branding": branding_result,
            "sample_data": sample_data
        }
        
        return onboarding.deployment_info
    
    async def _handle_testing(
        self,
        onboarding: PartnerOnboarding
    ) -> Dict:
        """Step 6: ê²€ì¦ ë° í™œì„±í™”"""
        partner = onboarding.partner
        
        # í†µí•© í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        test_results = await self._run_integration_tests(partner)
        
        # ë³´ì•ˆ ì²´í¬ë¦¬ìŠ¤íŠ¸ ê²€ì¦
        security_check = await self._verify_security_checklist(onboarding)
        
        # ì„±ëŠ¥ í…ŒìŠ¤íŠ¸
        performance_test = await self._run_performance_test(partner)
        
        # ìµœì¢… í™œì„±í™”
        if all([
            test_results["passed"],
            security_check["passed"],
            performance_test["passed"]
        ]):
            await self.partner_service.activate_partner(partner.id)
            onboarding.testing_completed = True
        
        return {
            "integration_tests": test_results,
            "security_check": security_check,
            "performance_test": performance_test,
            "activated": onboarding.testing_completed
        }
    
    async def _create_checklist(self, onboarding_id: int):
        """ì˜¨ë³´ë”© ì²´í¬ë¦¬ìŠ¤íŠ¸ ìƒì„±"""
        checklist_items = [
            # ë³´ì•ˆ ì²´í¬ë¦¬ìŠ¤íŠ¸
            ("security", "API í‚¤ ì•ˆì „í•˜ê²Œ ì €ì¥", True),
            ("security", "2FA ì„¤ì • ì™„ë£Œ", True),
            ("security", "IP í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ ì„¤ì •", False),
            ("security", "ì›¹í›… URL HTTPS ì‚¬ìš©", True),
            
            # í†µí•© ì²´í¬ë¦¬ìŠ¤íŠ¸
            ("integration", "TronLink ì§€ê°‘ ì—°ë™", True),
            ("integration", "API ì—°ë™ í…ŒìŠ¤íŠ¸ ì™„ë£Œ", True),
            ("integration", "ì›¹í›… ìˆ˜ì‹  í…ŒìŠ¤íŠ¸", True),
            ("integration", "ì—ëŸ¬ ì²˜ë¦¬ êµ¬í˜„", True),
            
            # ì»´í”Œë¼ì´ì–¸ìŠ¤ ì²´í¬ë¦¬ìŠ¤íŠ¸
            ("compliance", "ì´ìš©ì•½ê´€ ë™ì˜", True),
            ("compliance", "ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨ ë™ì˜", True),
            ("compliance", "AML/KYC ì •ì±… í™•ì¸", True),
            ("compliance", "ë°ì´í„° ë³´ê´€ ì •ì±… í™•ì¸", False)
        ]
        
        for category, item_name, is_required in checklist_items:
            checklist = OnboardingChecklist(
                onboarding_id=onboarding_id,
                category=category,
                item_name=item_name,
                is_required=is_required
            )
            self.db.add(checklist)